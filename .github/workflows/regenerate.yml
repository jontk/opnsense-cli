name: Regenerate SDK

on:
  schedule:
    # Run on the 1st of each month at 06:00 UTC (aligns with OPNsense quarterly releases)
    - cron: "0 6 1 * *"
  workflow_dispatch: # allow manual trigger

jobs:
  regenerate:
    name: Crawl docs and regenerate SDK
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install Python dependencies
        run: pip install requests beautifulsoup4 markdownify jinja2

      - name: Run full pipeline
        run: make all

      - name: Check for changes
        id: diff
        run: |
          git diff --quiet opnsense/ || echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Create pull request
        if: steps.diff.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: regenerate SDK from latest OPNsense docs"
          branch: chore/regenerate-sdk
          delete-branch: true
          title: "chore: regenerate SDK from latest OPNsense docs"
          body: |
            Automated weekly regeneration of the Go SDK from the latest OPNsense API documentation.

            Review the diff to check for new endpoints, changed types, or removed endpoints before merging.
          labels: automated
