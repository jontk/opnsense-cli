// Code generated by opnsense-cli/generate; DO NOT EDIT.

package gen

{% set needs_json = m.resources | selectattr("verbs") | map(attribute="verbs") | sum(start=[]) | selectattr("has_data_flag") | list | length > 0 %}
import (
	"context"
{% if needs_json %}
	"encoding/json"
{% endif %}
	"fmt"

	"github.com/jontk/opnsense-cli/internal/cli"
	sdk "{{ m.sdk_package }}"
	"github.com/spf13/cobra"
)

func init() {
	register{{ m.go_file_ident }}()
}

func register{{ m.go_file_ident }}() {
	moduleCmd := &cobra.Command{
		Use:   "{{ m.cli_name }}",
		Short: "Manage {{ m.cli_name }} resources",
		RunE: func(cmd *cobra.Command, args []string) error {
			if len(args) == 0 {
				return cmd.Help()
			}
			msg := fmt.Sprintf("unknown command %q for %q", args[0], cmd.CommandPath())
			if sugg := cmd.SuggestionsFor(args[0]); len(sugg) > 0 {
				msg += "\n\nDid you mean this?"
				for _, s := range sugg {
					msg += "\n\t" + s
				}
			}
			return fmt.Errorf("%s\n\nRun '%s --help' for usage.", msg, cmd.CommandPath())
		},
	}
{% for res in m.resources %}
	moduleCmd.AddCommand(new{{ m.go_file_ident }}{{ res.go_ident }}Cmd())
{% endfor %}
	cli.Root.AddCommand(moduleCmd)
}

{% for res in m.resources %}
{% if res.columns %}
// {{ m.package_name }}{{ res.go_ident }}Columns defines table columns for the {{ res.go_ident }} resource.
var {{ m.package_name }}{{ res.go_ident }}Columns = []cli.Column{
{% for col in res.columns %}
	{Header: "{{ col.header }}", Extract: func(row any) string {
		if v, ok := row.(sdk.{{ res.item_type }}); ok {
{% if col.go_type.startswith('*') %}
			if v.{{ col.field_name }} != nil {
				return fmt.Sprint(*v.{{ col.field_name }})
			}
			return ""
{% else %}
			return fmt.Sprint(v.{{ col.field_name }})
{% endif %}
		}
		return ""
	}},
{% endfor %}
}

{% endif %}
func new{{ m.go_file_ident }}{{ res.go_ident }}Cmd() *cobra.Command {
	cmd := &cobra.Command{
		Use:   "{{ res.resource }}",
		Short: "Manage {{ m.cli_name }} {{ res.resource }} resources",
	}
{% for verb in res.verbs %}
	cmd.AddCommand(new{{ m.go_file_ident }}{{ res.go_ident }}{{ verb.cli_verb | replace("-", " ") | title | replace(" ", "") }}Cmd())
{% endfor %}
	return cmd
}

{% for verb in res.verbs %}
{% set verb_go = verb.cli_verb | replace("-", " ") | title | replace(" ", "") %}
{% set n = verb.positional_params | length %}
func new{{ m.go_file_ident }}{{ res.go_ident }}{{ verb_go }}Cmd() *cobra.Command {
{% if verb.is_search %}
{# ── Search (list): optional body for POST, no body for GET ── #}
	return &cobra.Command{
		Use:   "{{ verb.cli_verb }}",
		Short: "List {{ m.module_name }} {{ res.resource }} resources",
		RunE: func(cmd *cobra.Command, args []string) error {
			c, cfg, err := cli.NewClientFromCmd(cmd)
			if err != nil {
				return err
			}
			s := sdk.NewClient(c)
{% if verb.search_needs_body %}
			result, err := s.{{ verb.go_method }}(context.Background(), map[string]any{"rowCount": -1, "current": 1})
{% else %}
			result, err := s.{{ verb.go_method }}(context.Background())
{% endif %}
			if err != nil {
				return err
			}
			printer := cli.NewPrinter(cfg)
{% if res.columns %}
			rows := make([]any, len(result.Rows))
			for i, r := range result.Rows {
				rows[i] = r
			}
			return printer.PrintTable(rows, {{ m.package_name }}{{ res.go_ident }}Columns)
{% else %}
			return printer.PrintJSON(result)
{% endif %}
		},
	}
{% elif verb.has_data_flag %}
{# ── Typed create/update: --data flag + positional args ── #}
{% if n > 0 %}
	cmd := &cobra.Command{
		Use:   "{{ verb.cli_verb }}{% for p in verb.positional_params %} <{{ p }}>{% endfor %}",
		Short: "{{ verb_go }} {{ m.module_name }} {{ res.resource }}",
		Args:  cobra.ExactArgs({{ n }}),
		RunE: func(cmd *cobra.Command, args []string) error {
			c, cfg, err := cli.NewClientFromCmd(cmd)
			if err != nil {
				return err
			}
			dataStr, _ := cmd.Flags().GetString("data")
			var body sdk.{{ verb.item_type }}
			if err := json.Unmarshal([]byte(dataStr), &body); err != nil {
				return fmt.Errorf("parsing --data: %w", err)
			}
			s := sdk.NewClient(c)
			resp, err := s.{{ verb.go_method }}(context.Background(){% for i in range(n) %}, args[{{ i }}]{% endfor %}, &body)
			if err != nil {
				return err
			}
			printer := cli.NewPrinter(cfg)
			return printer.PrintGenericResponse(resp)
		},
	}
{% else %}
	cmd := &cobra.Command{
		Use:   "{{ verb.cli_verb }}",
		Short: "{{ verb_go }} {{ m.module_name }} {{ res.resource }}",
		RunE: func(cmd *cobra.Command, args []string) error {
			c, cfg, err := cli.NewClientFromCmd(cmd)
			if err != nil {
				return err
			}
			dataStr, _ := cmd.Flags().GetString("data")
			var body sdk.{{ verb.item_type }}
			if err := json.Unmarshal([]byte(dataStr), &body); err != nil {
				return fmt.Errorf("parsing --data: %w", err)
			}
			s := sdk.NewClient(c)
			resp, err := s.{{ verb.go_method }}(context.Background(), &body)
			if err != nil {
				return err
			}
			printer := cli.NewPrinter(cfg)
			return printer.PrintGenericResponse(resp)
		},
	}
{% endif %}
	cmd.Flags().String("data", "{}", "JSON body (can use '-' to read from stdin)")
	return cmd
{% elif n > 0 %}
{# ── Positional args (get/delete/toggle/untyped with path params) ── #}
	return &cobra.Command{
		Use:   "{{ verb.cli_verb }}{% for p in verb.positional_params %} <{{ p }}>{% endfor %}",
		Short: "{{ verb_go }} {{ m.module_name }} {{ res.resource }}",
		Args:  cobra.ExactArgs({{ n }}),
		RunE: func(cmd *cobra.Command, args []string) error {
			c, cfg, err := cli.NewClientFromCmd(cmd)
			if err != nil {
				return err
			}
			s := sdk.NewClient(c)
{% if verb.has_body_arg %}
			resp, err := s.{{ verb.go_method }}(context.Background(){% for i in range(n) %}, args[{{ i }}]{% endfor %}, nil)
{% else %}
			resp, err := s.{{ verb.go_method }}(context.Background(){% for i in range(n) %}, args[{{ i }}]{% endfor %})
{% endif %}
			if err != nil {
				return err
			}
			printer := cli.NewPrinter(cfg)
{% if verb.crud_verb == "get" and verb.is_typed and res.columns %}
			return printer.PrintItem(resp, {{ m.package_name }}{{ res.go_ident }}Columns)
{% elif verb.is_typed %}
			return printer.PrintGenericResponse(resp)
{% else %}
			return printer.PrintJSON(resp)
{% endif %}
		},
	}
{% elif verb.has_body_arg %}
{# ── No positional args, untyped POST (pass nil body) ── #}
	return &cobra.Command{
		Use:   "{{ verb.cli_verb }}",
		Short: "{{ verb_go }} {{ m.module_name }} {{ res.resource }}",
		RunE: func(cmd *cobra.Command, args []string) error {
			c, cfg, err := cli.NewClientFromCmd(cmd)
			if err != nil {
				return err
			}
			s := sdk.NewClient(c)
			resp, err := s.{{ verb.go_method }}(context.Background(), nil)
			if err != nil {
				return err
			}
			printer := cli.NewPrinter(cfg)
			return printer.PrintJSON(resp)
		},
	}
{% else %}
{# ── No positional args, no body (GET-like) ── #}
	return &cobra.Command{
		Use:   "{{ verb.cli_verb }}",
		Short: "{{ verb_go }} {{ m.module_name }} {{ res.resource }}",
		RunE: func(cmd *cobra.Command, args []string) error {
			c, cfg, err := cli.NewClientFromCmd(cmd)
			if err != nil {
				return err
			}
			s := sdk.NewClient(c)
			resp, err := s.{{ verb.go_method }}(context.Background())
			if err != nil {
				return err
			}
			printer := cli.NewPrinter(cfg)
{% if verb.is_typed %}
			return printer.PrintGenericResponse(resp)
{% else %}
			return printer.PrintJSON(resp)
{% endif %}
		},
	}
{% endif %}
}

{% endfor %}
{% endfor %}
